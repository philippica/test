<!DOCTYPE html>
<html>
<head>
  <title>电影院排座</title>
  <style>
    text {
        font-size: small;
    }
  </style>
</head>
<body>
  <label for="n">总共列数</label>
  <input type="number" id="n" name="n" value="9" oninput="generateGrid(true)"><br>

  <label for="m">总共排数</label>
  <input type="number" id="m" name="m" value="9" oninput="generateGrid(true)"><br>
  
  <label for="aislecol">过道列数（竖） 用空格隔开</label>
  <input id="aislecol" name="aislecol" value="2 6" oninput="generateGrid(true)"><br>

  <label for="aisleRow">过道排数（横） 用空格隔开</label>
  <input id="aisleRow" name="aisleRow" value="3" oninput="generateGrid(true)"><br>
  <div>选中目标后按ctrl + C复制， 再选中另一个目标ctrl + V可以复制全部信息哦~~</div>
  <div>
    <span>选择电影院/包厢</span>
    <select id="roomSelect" onchange="onchangeRoom(this)">
      <option>未命名包厢</option>
      <option>新建包厢</option>
    </select>
    <span>当前包厢</span>
    <input id="room" value="未命名包厢" onchange="generateRoom()">
    <span><button onclick="deleteRoom()">删除当前包厢</button></span>
</div>

<div>
  <span>选择时刻</span>
  <select id="timeSelect" onchange="onchangetime(this)">
    <option>未命名时刻</option>
    <option>新建时刻</option>
  </select>
  <span>当前时刻</span>
  <input id="timeline" value="未命名时刻" onchange="generateTimeline()">
  <span><button onclick="deletetime()">删除当前时刻</button></span>
</div>


  <button onclick="save()">保存结果</button>

  <div style="display:flex">
    <div id='container'>
        <svg id="my-svg" width="50%" height="500px"></svg>
    </div>
    <div>
        <div>选中座位名字：</div>
        <textarea id="seatName" oninput="editName()"></textarea>
        <div>选中座位颜色：</div>
        <div style="display:flex; width: 200px; margin: 10px;flex-wrap: wrap;">
            <div style="width: 20px; height: 20px; background-color: #c5c3c3a3; margin:5px" onclick="pickcolor(this)"></div>
            
            <div style="width: 20px;height: 20px;background-color: #f47070;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #fec780;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #ffd000;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #bff48b;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #7af2aa;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #6281f1;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #ea68f2;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #c39b9b;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #4f4334;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #c1ba9a;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #bbd1a4;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #c5f4d7;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #b0bff5;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #e9b6ec;margin:5px" onclick="pickcolor(this)"></div>

        </div>
        <div>选中座位附加信息：</div>
        <textarea id="appendInfo" oninput="editAppend()" style="height: 100px"></textarea>
    </div>
  </div>
</body>
  <script>
let selectedSeat=[],copyedSeat,cinimaName="未命名包厢",timeName="未命名时刻",multiSelect=!1,storedCinemas={};const deleteRoom=()=>{let e=[];for(var t=0;t<localStorage.length;t++){let l=localStorage.key(t);l.startsWith(`${cinimaName}_z_`)&&e.push(l)}for(var t=0;t<localStorage.length;t++){let n=localStorage.key(t);n.startsWith(`${cinimaName}_p_`)&&e.push(n)}for(let i of e)localStorage.removeItem(i);location.reload()},deletetime=()=>{localStorage.removeItem(`${cinimaName}_z_${timeName}`);let e=!1;for(var t=0;t<localStorage.length;t++){let l=localStorage.key(t);if(l.startsWith(`${cinimaName}_z_`)){e=!0;break}}!1===e&&(localStorage.removeItem(`${cinimaName}_p_n`),localStorage.removeItem(`${cinimaName}_p_m`),localStorage.removeItem(`${cinimaName}_p_row`),localStorage.removeItem(`${cinimaName}_p_col`)),alert("删除成功"),location.reload()},onClick=e=>{e.target;let t=document.getElementById("appendInfo"),l=document.getElementById("seatName");if(multiSelect){let n=e.target.getAttribute("name"),i=document.getElementsByName(n);if(selectedSeat.push(i[0]),i[0].setAttribute("stroke","#ed9393"),selectedSeat.length>1)t.value="",l.value="";else{let a=document.getElementsByName(`t${selectedSeat[0].getAttribute("name")}`);t.value=a[0].innerHTML,l.value=i[1].innerHTML}return}let m=document.getElementById("my-svg").getElementsByTagName("rect");for(let r of m)r.setAttribute("stroke","black");selectedSeat=[e.target];let o=selectedSeat[0].getAttribute("name"),s=document.getElementsByName(o);selectedSeat=[s[0]],l.value=s[1].innerHTML,selectedSeat[0].setAttribute("stroke","#ed9393");let c=document.getElementsByName(`t${selectedSeat[0].getAttribute("name")}`);t.value=c[0].innerHTML},generateTimeline=()=>{let e=document.getElementById("timeline").value,t=document.getElementById("timeSelect");t.options[t.selectedIndex].innerHTML=e,localStorage.removeItem(`${cinimaName}_z_${timeName}`),timeName=e,save()},generateRoom=()=>{let e=document.getElementById("room").value,t=document.getElementById("roomSelect");t.options[t.selectedIndex].innerHTML=e;let l=[];for(var n=0;n<localStorage.length;n++){let i=localStorage.key(n),a=localStorage.getItem(i);if(i.startsWith(`${cinimaName}_z_`)){l.push(i);let m=i.split("_z_");localStorage.setItem(`${e}_z_${m[1]}`,a)}if(i.startsWith(`${cinimaName}_p_`)){l.push(i);let r=i.split("_p_");localStorage.setItem(`${e}_p_${r[1]}`,a)}}for(let o of l)localStorage.removeItem(o);cinimaName=e,save()},save=()=>{let e=document.getElementById("my-svg").getElementsByTagName("rect");for(let t of e)t.setAttribute("stroke","black");window.localStorage.setItem(`${cinimaName}_p_n`,document.getElementById("n").value),window.localStorage.setItem(`${cinimaName}_p_row`,document.getElementById("aisleRow").value),window.localStorage.setItem(`${cinimaName}_p_m`,document.getElementById("m").value),window.localStorage.setItem(`${cinimaName}_p_col`,document.getElementById("aislecol").value),window.localStorage.setItem(`${cinimaName}_z_${timeName}`,document.getElementById("container").innerHTML),alert("保存成功")},recover=e=>{document.getElementById("container").innerHTML=window.localStorage.getItem(e),setInterval(()=>{let e=document.getElementById("my-svg").getElementsByTagName("rect");for(let t of e)t.onclick=onClick;let l=document.getElementById("my-svg").getElementsByTagName("text");for(let n of l)n.innerHTML&&"第"==n.innerHTML[0]||(n.onclick=onClick)},500)},onchangeRoom=e=>{let t=e.options[e.selectedIndex].innerHTML;if(save(),cinimaName=t,document.getElementById("room").value=t,"新建包厢"==t){e.selectedIndex;let l=`未命名包厢${e.options.length}`;document.getElementById("room").value=l,cinimaName=l;let n=document.getElementById("my-svg").getElementsByTagName("rect");for(let i of n)i.setAttribute("fill","#c5c3c3a3"),i.firstChild.innerHTML="";let a=document.getElementById("my-svg").getElementsByTagName("text");for(let m of a)m.innerHTML&&"第"==m.innerHTML[0]||(m.innerHTML="");timeName="未命名时刻",document.getElementById("roomSelect").value=l,e.innerHTML=`<option>${l}</option>`+e.innerHTML,e.selectedIndex=0;let r=document.getElementById("timeSelect");r.innerHTML="<option>未命名时刻</option><option>新建时刻</option>",document.getElementById("timeline").value=timeName;return}recoverFull(!1)},onchangetime=e=>{let t=e.options[e.selectedIndex].innerHTML;if(save(),"新建时刻"==t){let l=e.selectedIndex;e.options[e.selectedIndex].innerHTML=`未命名时刻${e.options.length}`;let n=document.getElementById("my-svg").getElementsByTagName("rect");for(let i of n)i.setAttribute("fill","#c5c3c3a3"),i.firstChild.innerHTML="";let a=document.getElementById("my-svg").getElementsByTagName("text");for(let m of a)m.innerHTML&&"第"==m.innerHTML[0]||(m.innerHTML="");timeName=e.options[e.selectedIndex].innerHTML,document.getElementById("timeline").value=e.options[e.selectedIndex].innerHTML,e.innerHTML+=`<option>新建时刻</option>`,e.selectedIndex=l;return}timeName=e.options[e.selectedIndex].innerHTML,document.getElementById("timeline").value=e.options[e.selectedIndex].innerHTML,recover(`${cinimaName}_z_${t}`)},editName=()=>{let e=document.getElementById("seatName").value;if(0!==selectedSeat.length)for(let t of selectedSeat){let l=t.getAttribute("name"),n=document.getElementsByName(l);var i=n[1].getBBox(),a=i.width;n[1].innerHTML=e,i=n[1].getBBox().width;let m=parseFloat(n[1].getAttribute("x"));n[1].setAttribute("x",m+a/2-i/2)}},editAppend=()=>{let e=document.getElementById("appendInfo").value;if(0!==selectedSeat.length)for(let t of selectedSeat){let l=t.getAttribute("name"),n=document.getElementsByName(`t${l}`);n[0].innerHTML=e}},pickcolor=e=>{if(console.info(e.style.backgroundColor),0!==selectedSeat.length)for(let t of selectedSeat){let l=t.getAttribute("name"),n=document.getElementsByName(l);n[0].setAttribute("fill",e.style.backgroundColor)}};function generateRow(e,t,l){var n=document.createElementNS("http://www.w3.org/2000/svg","text");n.textContent=l,n.setAttribute("x",t.x),n.setAttribute("y",t.y),e.appendChild(n)}function generateNode(e,t,l,n,i,a,m){var r=document.createElementNS("http://www.w3.org/2000/svg","rect");r.setAttribute("x",t.x+n/2),r.setAttribute("y",t.y+i/2),r.setAttribute("width",l.width-n),r.setAttribute("height",l.height),r.setAttribute("rx",10),r.setAttribute("name",`r${a}c${m}`),r.setAttribute("stroke-width",3),r.setAttribute("stroke","black"),r.setAttribute("fill","#c5c3c3a3"),r.onclick=onClick;var o=document.createElementNS("http://www.w3.org/2000/svg","title");o.setAttribute("name",`tr${a}c${m}`),r.appendChild(o),e.appendChild(r);var s=document.createElementNS("http://www.w3.org/2000/svg","text");s.setAttribute("name",`r${a}c${m}`),s.onclick=onClick,s.textContent="",s.setAttribute("x",t.x+n/2),s.setAttribute("y",t.y+i/2+l.height/2),e.appendChild(s);var c=s.getBBox().width;s.setAttribute("x",t.x+n/2+l.width/2-c/2)}const recoverFull=e=>{let t=[],l=!0;if(!1!==e){for(var n=0;n<localStorage.length;n++){let i=localStorage.key(n);if(i.includes("_p_n")){l=!1;let a=i.split("_p_n");t.push(a[0])}}if(l)return!1;for(let m of(cinimaName=t[0],document.getElementById("roomSelect").innerHTML="",t))document.getElementById("roomSelect").innerHTML+=`<option>${m}</option>`;document.getElementById("roomSelect").innerHTML+=`<option>新建包厢</option>`}document.getElementById("n").value=window.localStorage.getItem(`${cinimaName}_p_n`),document.getElementById("m").value=window.localStorage.getItem(`${cinimaName}_p_m`),document.getElementById("room").value=cinimaName,document.getElementById("aisleRow").value=window.localStorage.getItem(`${cinimaName}_p_row`),document.getElementById("aislecol").value=window.localStorage.getItem(`${cinimaName}_p_col`);let r="",o=!1;for(var n=0;n<localStorage.length;n++){let s=localStorage.key(n);if(s.startsWith(cinimaName)){let c=s.split("_z_");if(!c[1])continue;r+=`<option>${c[1]}</option>`,!1==o&&(recover(s),o=!0)}}r+="<option>新建时刻</option>";let g=document.getElementById("timeSelect");return g.innerHTML=r,timeName=g.options[g.selectedIndex].innerHTML,document.getElementById("timeline").value=timeName,!0};function generateGrid(e){if(e&&(window.localStorage.setItem(`${cinimaName}_p_n`,document.getElementById("n").value),window.localStorage.setItem(`${cinimaName}_p_row`,document.getElementById("aisleRow").value),window.localStorage.setItem(`${cinimaName}_p_m`,document.getElementById("m").value),window.localStorage.setItem(`${cinimaName}_p_col`,document.getElementById("aislecol").value)),!0!==e&&recoverFull(!0))return;var t=document.getElementById("my-svg"),l=parseInt(document.getElementById("n").value),n=parseInt(document.getElementById("m").value),i=document.getElementById("aislecol").value.split(" ").map(e=>parseInt(e)-1),a=document.getElementById("aisleRow").value.split(" ").map(e=>parseInt(e)-1);for(t.getBoundingClientRect().width,t.getBoundingClientRect().height;t.firstChild;)t.removeChild(t.firstChild);let m=0,r=0;for(var o=0;o<l;o++)for(var s=0;s<n;s++){var c={x:100+52*o,y:100+60*s};let g=0;for(;g<i.length&&o>i[g];)c.x+=30,g++;for(g=0;g<a.length&&s>a[g];)c.y+=30,g++;generateNode(t,c,{width:50,height:50},2,10,o,s),m=Math.max(m,c.x+50+100),r=Math.max(r,c.y+50+100)}for(let d=0;d<n;d++){let y={x:5,y:100+60*d+100/3},u=0;for(;u<a.length&&d>a[u];)y.y+=30,u++;generateRow(t,y,`第${n-d}排`)}t.style.width=m,t.style.height=r}document.addEventListener("keydown",function(e){var t=e.which||e.keyCode,l=e.ctrlKey?e.ctrlKey:17===t;if("Delete"===e.key||46===e.keyCode&&selectedSeat.length>0){for(let n of selectedSeat){let i=document.getElementsByName(n.getAttribute("name"));for(;i.length;)i[0].remove()}selectedSeat[0].remove(),selectedSeat=[]}if(86==t&&l){if(console.log("Ctrl+V is pressed."),!copyedSeat||0===selectedSeat.length)return;let a=document.getElementsByName(copyedSeat.getAttribute("name")),m=document.getElementsByName(selectedSeat[0].getAttribute("name"));m[0].style.color=a[0].style.color,m[0].setAttribute("fill",a[0].getAttribute("fill"));var r=m[1].getBBox(),o=r.width;m[1].innerHTML=a[1].innerHTML,r=m[1].getBBox().width;let s=parseFloat(m[1].getAttribute("x"));m[1].setAttribute("x",s+o/2-r/2),m[0].firstChild.innerHTML=a[0].firstChild.innerHTML}else if(67==t&&l){if(0===selectedSeat.length)return;copyedSeat=selectedSeat[0]}else l&&(multiSelect=!0)}),document.addEventListener("keyup",function(e){e.which||e.keyCode,e.ctrlKey&&e.ctrlKey,console.info(multiSelect),multiSelect=!1,console.info(multiSelect)}),generateGrid();

  </script>
</html>
