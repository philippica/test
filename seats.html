<!DOCTYPE html>
<html>
<head>
  <title>电影院排座</title>
  <style>
    text {
        font-size: small;
    }
  </style>
</head>
<body>
  <label for="n">总共列数</label>
  <input type="number" id="n" name="n" value="9" oninput="generateGrid(true)"><br>

  <label for="m">总共排数</label>
  <input type="number" id="m" name="m" value="9" oninput="generateGrid(true)"><br>
  
  <label for="aislecol">过道列数（竖） 用空格隔开</label>
  <input id="aislecol" name="aislecol" value="2 6" oninput="generateGrid()"><br>

  <label for="aisleRow">过道排数（横） 用空格隔开</label>
  <input id="aisleRow" name="aisleRow" value="3" oninput="generateGrid()"><br>
  <div>选中目标后按ctrl + C复制， 再选中另一个目标ctrl + V可以复制全部信息哦~~</div>
  <div>
      <span>选择时刻</span>
      <select id="timeSelect" onchange="onchangetime(this)">
        <option>未命名时刻</option>
        <option>新建时刻</option>
      </select>
      <span>当前时刻</span>
      <input id="timeline" value="未命名时刻" oninput="generateTimeline()" onchange="timelineNameChange()"><br>
  </div>
  <button>保存结果</button>

  <div style="display:flex">
    <div id='container'>
        <svg id="my-svg" width="50%" height="500px"></svg>
    </div>
    <div>
        <div>选中座位名字：</div>
        <textarea id="seatName" oninput="editName()"></textarea>
        <div>选中座位颜色：</div>
        <div style="display:flex; width: 200px; margin: 10px;flex-wrap: wrap;">
            <div style="width: 20px; height: 20px; background-color: #c5c3c3a3; margin:5px" onclick="pickcolor(this)"></div>
            
            <div style="width: 20px;height: 20px;background-color: #f47070;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #fec780;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #ffd000;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #bff48b;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #7af2aa;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #6281f1;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #ea68f2;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #c39b9b;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #4f4334;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #c1ba9a;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #bbd1a4;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #c5f4d7;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #b0bff5;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #e9b6ec;margin:5px" onclick="pickcolor(this)"></div>

        </div>
        <div>选中座位附加信息：</div>
        <textarea id="appendInfo" oninput="editAppend()" style="height: 100px"></textarea>
    </div>
  </div>
</body>
  <script>
let selectedSeat,copyedSeat,cinimaName="wonder",timeName="未命名时刻";const timelineNameChange=()=>{},onClick=e=>{e.target,selectedSeat&&selectedSeat.setAttribute("stroke","black"),selectedSeat=e.target;let t=selectedSeat.getAttribute("name"),n=document.getElementsByName(t),l=document.getElementById("seatName");selectedSeat=n[0],l.value=n[1].innerHTML,selectedSeat.setAttribute("stroke","#ed9393");let i=document.getElementsByName(`t${selectedSeat.getAttribute("name")}`),r=document.getElementById("appendInfo");r.value=i[0].innerHTML},generateTimeline=()=>{let e=document.getElementById("timeline").value,t=document.getElementById("timeSelect");t.options[t.selectedIndex].innerHTML=e,timeName=e},save=()=>{window.localStorage.setItem(`${cinimaName}n`,document.getElementById("n").value),window.localStorage.setItem(`${cinimaName}m`,document.getElementById("m").value),window.localStorage.setItem(`${cinimaName}_z_${timeName}`,document.getElementById("container").innerHTML)},recover=e=>{document.getElementById("container").innerHTML=window.localStorage.getItem(e),setInterval(()=>{let e=document.getElementById("my-svg").getElementsByTagName("rect");for(let t of e)t.onclick=onClick;let n=document.getElementById("my-svg").getElementsByTagName("text");for(let l of n)l.innerHTML&&"第"==l.innerHTML[0]||(l.onclick=onClick)},500)},onchangetime=e=>{let t=e.options[e.selectedIndex].innerHTML;if(save(),"新建时刻"==t){let n=e.selectedIndex;e.options[e.selectedIndex].innerHTML=`未命名时刻${e.options.length}`;let l=document.getElementById("my-svg").getElementsByTagName("rect");for(let i of l)i.setAttribute("fill","#c5c3c3a3"),i.firstChild.innerHTML="";let r=document.getElementById("my-svg").getElementsByTagName("text");for(let a of r)a.innerHTML&&"第"==a.innerHTML[0]||(a.innerHTML="");timeName=e.options[e.selectedIndex].innerHTML,document.getElementById("timeline").value=e.options[e.selectedIndex].innerHTML,e.innerHTML+=`<option>新建时刻</option>`,e.selectedIndex=n;return}timeName=e.options[e.selectedIndex].innerHTML,document.getElementById("timeline").value=e.options[e.selectedIndex].innerHTML,recover(`${cinimaName}_z_${t}`)},editName=()=>{let e=document.getElementById("seatName").value;if(!selectedSeat)return;let t=selectedSeat.getAttribute("name"),n=document.getElementsByName(t);var l=n[1].getBBox(),i=l.width;n[1].innerHTML=e,l=n[1].getBBox().width;let r=parseFloat(n[1].getAttribute("x"));n[1].setAttribute("x",r+i/2-l/2)},editAppend=()=>{let e=document.getElementById("appendInfo").value;if(!selectedSeat)return;let t=selectedSeat.getAttribute("name"),n=document.getElementsByName(`t${t}`);n[0].innerHTML=e},pickcolor=e=>{if(console.info(e.style.backgroundColor),!selectedSeat)return;let t=selectedSeat.getAttribute("name"),n=document.getElementsByName(t);n[0].setAttribute("fill",e.style.backgroundColor)};function generateRow(e,t,n){var l=document.createElementNS("http://www.w3.org/2000/svg","text");l.textContent=n,l.setAttribute("x",t.x),l.setAttribute("y",t.y),e.appendChild(l)}function generateNode(e,t,n,l,i,r,a){var o=document.createElementNS("http://www.w3.org/2000/svg","rect");o.setAttribute("x",t.x+l/2),o.setAttribute("y",t.y+i/2),o.setAttribute("width",n.width-l),o.setAttribute("height",n.height),o.setAttribute("rx",10),o.setAttribute("name",`r${r}c${a}`),o.setAttribute("stroke-width",3),o.setAttribute("stroke","black"),o.setAttribute("fill","#c5c3c3a3"),o.onclick=onClick;var m=document.createElementNS("http://www.w3.org/2000/svg","title");m.setAttribute("name",`tr${r}c${a}`),o.appendChild(m),e.appendChild(o);var s=document.createElementNS("http://www.w3.org/2000/svg","text");s.setAttribute("name",`r${r}c${a}`),s.onclick=onClick,s.textContent="",s.setAttribute("x",t.x+l/2),s.setAttribute("y",t.y+i/2+n.height/2),e.appendChild(s);var d=s.getBBox().width;s.setAttribute("x",t.x+l/2+n.width/2-d/2)}const recoverFull=()=>{document.getElementById("n").value=window.localStorage.getItem(`${cinimaName}n`),document.getElementById("m").value=window.localStorage.getItem(`${cinimaName}m`);let e="",t=!1;for(var n=0;n<localStorage.length;n++){let l=localStorage.key(n);if(l.startsWith(cinimaName)){let i=l.split("_z_");if(!i[1])continue;e+=`<option>${i[1]}</option>`,!1==t&&(recover(l),t=!0)}}e+="<option>新建时刻</option>";let r=document.getElementById("timeSelect");r.innerHTML=e,timeName=r.options[r.selectedIndex].innerHTML};function generateGrid(e){if(e)for(var t=0;t<localStorage.length;t++){let n=localStorage.key(t);n.startsWith(cinimaName)&&window.localStorage.removeItem(n)}if(window.localStorage.getItem(`${cinimaName}n`)){recoverFull();return}var l=document.getElementById("my-svg"),i=parseInt(document.getElementById("n").value),r=parseInt(document.getElementById("m").value),a=document.getElementById("aislecol").value.split(" ").map(e=>parseInt(e)-1),o=document.getElementById("aisleRow").value.split(" ").map(e=>parseInt(e)-1);for(l.getBoundingClientRect().width,l.getBoundingClientRect().height;l.firstChild;)l.removeChild(l.firstChild);let m=0,s=0;for(var t=0;t<i;t++)for(var d=0;d<r;d++){var c={x:100+52*t,y:100+60*d};let g=0;for(;g<a.length&&t>a[g];)c.x+=30,g++;for(g=0;g<o.length&&d>o[g];)c.y+=30,g++;generateNode(l,c,{width:50,height:50},2,10,t,d),m=Math.max(m,c.x+50+100),s=Math.max(s,c.y+50+100)}for(let y=0;y<r;y++){let u={x:5,y:100+60*y+100/3},$=0;for(;$<o.length&&y>o[$];)u.y+=30,$++;generateRow(l,u,`第${r-y}排`)}l.style.width=m,l.style.height=s}document.addEventListener("keydown",function(e){var t=e.which||e.keyCode,n=e.ctrlKey?e.ctrlKey:17===t;if(("Delete"===e.key||46===e.keyCode&&selectedSeat)&&(selectedSeat.remove(),selectedSeat=void 0),86==t&&n){if(console.log("Ctrl+V is pressed."),!copyedSeat||!selectedSeat)return;let l=document.getElementsByName(copyedSeat.getAttribute("name")),i=document.getElementsByName(selectedSeat.getAttribute("name"));i[0].style.color=l[0].style.color,i[0].setAttribute("fill",l[0].getAttribute("fill"));var r=i[1].getBBox(),a=r.width;i[1].innerHTML=l[1].innerHTML,r=i[1].getBBox().width;let o=parseFloat(i[1].getAttribute("x"));i[1].setAttribute("x",o+a/2-r/2),i[0].firstChild.innerHTML=l[0].firstChild.innerHTML}else if(67==t&&n){if(!selectedSeat)return;copyedSeat=selectedSeat}}),generateGrid();

  </script>
</html>
