<!DOCTYPE html>
<html>
<head>
  <title>电影院排座</title>
  <style>
    text {
        font-size: small;
    }
  </style>
</head>
<body>
  <label for="n">总共列数</label>
  <input type="number" id="n" name="n" value="9" oninput="generateGrid(true)"><br>

  <label for="m">总共排数</label>
  <input type="number" id="m" name="m" value="9" oninput="generateGrid(true)"><br>
  
  <label for="aislecol">过道列数（竖） 用空格隔开</label>
  <input id="aislecol" name="aislecol" value="2 6" oninput="generateGrid(true)"><br>

  <label for="aisleRow">过道排数（横） 用空格隔开</label>
  <input id="aisleRow" name="aisleRow" value="3" oninput="generateGrid(true)"><br>
  <div>选中目标后按ctrl + C复制， 再选中另一个目标ctrl + V可以复制全部信息哦~~</div>
  <div>
    <span>选择电影院/包厢</span>
    <select id="roomSelect" onchange="onchangeRoom(this)">
      <option>未命名包厢</option>
      <option>新建包厢</option>
    </select>
    <span>当前包厢</span>
    <input id="roomline" value="未命名包厢"><br>
</div>

<div>
  <span>选择时刻</span>
  <select id="timeSelect" onchange="onchangetime(this)">
    <option>未命名时刻</option>
    <option>新建时刻</option>
  </select>
  <span>当前时刻</span>
  <input id="timeline" value="未命名时刻" onchange="generateTimeline()"><br>
  <button onclick="deletetime()">删除当前时刻</button>
</div>


  <button onclick="save()">保存结果</button>

  <div style="display:flex">
    <div id='container'>
        <svg id="my-svg" width="50%" height="500px"></svg>
    </div>
    <div>
        <div>选中座位名字：</div>
        <textarea id="seatName" oninput="editName()"></textarea>
        <div>选中座位颜色：</div>
        <div style="display:flex; width: 200px; margin: 10px;flex-wrap: wrap;">
            <div style="width: 20px; height: 20px; background-color: #c5c3c3a3; margin:5px" onclick="pickcolor(this)"></div>
            
            <div style="width: 20px;height: 20px;background-color: #f47070;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #fec780;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #ffd000;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #bff48b;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #7af2aa;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #6281f1;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #ea68f2;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #c39b9b;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #4f4334;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #c1ba9a;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #bbd1a4;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #c5f4d7;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #b0bff5;margin:5px" onclick="pickcolor(this)"></div>
            <div style="width: 20px;height: 20px;background-color: #e9b6ec;margin:5px" onclick="pickcolor(this)"></div>

        </div>
        <div>选中座位附加信息：</div>
        <textarea id="appendInfo" oninput="editAppend()" style="height: 100px"></textarea>
    </div>
  </div>
</body>
  <script>
let selectedSeat=[],copyedSeat,cinimaName="未命名包厢",timeName="未命名时刻",multiSelect=!1;const deletetime=()=>{localStorage.removeItem(`${cinimaName}_z_${timeName}`);let e=!1;for(var t=0;t<localStorage.length;t++){let l=localStorage.key(t);if(l.startsWith(`${cinimaName}_z_`)){e=!0;break}}!1===e&&(localStorage.removeItem(`${cinimaName}n`),localStorage.removeItem(`${cinimaName}m`),localStorage.removeItem(`${cinimaName}row`),localStorage.removeItem(`${cinimaName}col`)),alert("删除成功"),location.reload()},onClick=e=>{e.target;let t=document.getElementById("appendInfo"),l=document.getElementById("seatName");if(multiSelect){let n=e.target.getAttribute("name"),i=document.getElementsByName(n);if(selectedSeat.push(i[0]),i[0].setAttribute("stroke","#ed9393"),selectedSeat.length>1)t.value="",l.value="";else{let a=document.getElementsByName(`t${selectedSeat[0].getAttribute("name")}`);t.value=a[0].innerHTML,l.value=i[1].innerHTML}return}let r=document.getElementById("my-svg").getElementsByTagName("rect");for(let m of r)m.setAttribute("stroke","black");selectedSeat=[e.target];let o=selectedSeat[0].getAttribute("name"),s=document.getElementsByName(o);selectedSeat=[s[0]],l.value=s[1].innerHTML,selectedSeat[0].setAttribute("stroke","#ed9393");let c=document.getElementsByName(`t${selectedSeat[0].getAttribute("name")}`);t.value=c[0].innerHTML},generateTimeline=()=>{let e=document.getElementById("timeline").value,t=document.getElementById("timeSelect");t.options[t.selectedIndex].innerHTML=e,localStorage.removeItem(`${cinimaName}_z_${timeName}`),timeName=e,save()},save=()=>{let e=document.getElementById("my-svg").getElementsByTagName("rect");for(let t of e)t.setAttribute("stroke","black");window.localStorage.setItem(`${cinimaName}n`,document.getElementById("n").value),window.localStorage.setItem(`${cinimaName}row`,document.getElementById("aisleRow").value),window.localStorage.setItem(`${cinimaName}m`,document.getElementById("m").value),window.localStorage.setItem(`${cinimaName}col`,document.getElementById("aislecol").value),window.localStorage.setItem(`${cinimaName}_z_${timeName}`,document.getElementById("container").innerHTML),alert("保存成功")},recover=e=>{document.getElementById("container").innerHTML=window.localStorage.getItem(e),setInterval(()=>{let e=document.getElementById("my-svg").getElementsByTagName("rect");for(let t of e)t.onclick=onClick;let l=document.getElementById("my-svg").getElementsByTagName("text");for(let n of l)n.innerHTML&&"第"==n.innerHTML[0]||(n.onclick=onClick)},500)},onchangeRoom=e=>{let t=e.options[e.selectedIndex].innerHTML;if(save(),cinimaName=t,"新建包厢"==t){let l=e.selectedIndex;e.options[e.selectedIndex].innerHTML=`未命名包厢${e.options.length}`;let n=document.getElementById("my-svg").getElementsByTagName("rect");for(let i of n)i.setAttribute("fill","#c5c3c3a3"),i.firstChild.innerHTML="";let a=document.getElementById("my-svg").getElementsByTagName("text");for(let r of a)r.innerHTML&&"第"==r.innerHTML[0]||(r.innerHTML="");timeName=e.options[e.selectedIndex].innerHTML,document.getElementById("roomSelect").value=e.options[e.selectedIndex].innerHTML,e.innerHTML+=`<option>新建包厢</option>`,e.selectedIndex=l;return}recoverFull()},onchangetime=e=>{let t=e.options[e.selectedIndex].innerHTML;if(save(),"新建时刻"==t){let l=e.selectedIndex;e.options[e.selectedIndex].innerHTML=`未命名时刻${e.options.length}`;let n=document.getElementById("my-svg").getElementsByTagName("rect");for(let i of n)i.setAttribute("fill","#c5c3c3a3"),i.firstChild.innerHTML="";let a=document.getElementById("my-svg").getElementsByTagName("text");for(let r of a)r.innerHTML&&"第"==r.innerHTML[0]||(r.innerHTML="");timeName=e.options[e.selectedIndex].innerHTML,document.getElementById("timeline").value=e.options[e.selectedIndex].innerHTML,e.innerHTML+=`<option>新建时刻</option>`,e.selectedIndex=l;return}timeName=e.options[e.selectedIndex].innerHTML,document.getElementById("timeline").value=e.options[e.selectedIndex].innerHTML,recover(`${cinimaName}_z_${t}`)},editName=()=>{let e=document.getElementById("seatName").value;if(0!==selectedSeat.length)for(let t of selectedSeat){let l=t.getAttribute("name"),n=document.getElementsByName(l);var i=n[1].getBBox(),a=i.width;n[1].innerHTML=e,i=n[1].getBBox().width;let r=parseFloat(n[1].getAttribute("x"));n[1].setAttribute("x",r+a/2-i/2)}},editAppend=()=>{let e=document.getElementById("appendInfo").value;if(0!==selectedSeat.length)for(let t of selectedSeat){let l=t.getAttribute("name"),n=document.getElementsByName(`t${l}`);n[0].innerHTML=e}},pickcolor=e=>{if(console.info(e.style.backgroundColor),0!==selectedSeat.length)for(let t of selectedSeat){let l=t.getAttribute("name"),n=document.getElementsByName(l);n[0].setAttribute("fill",e.style.backgroundColor)}};function generateRow(e,t,l){var n=document.createElementNS("http://www.w3.org/2000/svg","text");n.textContent=l,n.setAttribute("x",t.x),n.setAttribute("y",t.y),e.appendChild(n)}function generateNode(e,t,l,n,i,a,r){var m=document.createElementNS("http://www.w3.org/2000/svg","rect");m.setAttribute("x",t.x+n/2),m.setAttribute("y",t.y+i/2),m.setAttribute("width",l.width-n),m.setAttribute("height",l.height),m.setAttribute("rx",10),m.setAttribute("name",`r${a}c${r}`),m.setAttribute("stroke-width",3),m.setAttribute("stroke","black"),m.setAttribute("fill","#c5c3c3a3"),m.onclick=onClick;var o=document.createElementNS("http://www.w3.org/2000/svg","title");o.setAttribute("name",`tr${a}c${r}`),m.appendChild(o),e.appendChild(m);var s=document.createElementNS("http://www.w3.org/2000/svg","text");s.setAttribute("name",`r${a}c${r}`),s.onclick=onClick,s.textContent="",s.setAttribute("x",t.x+n/2),s.setAttribute("y",t.y+i/2+l.height/2),e.appendChild(s);var c=s.getBBox().width;s.setAttribute("x",t.x+n/2+l.width/2-c/2)}const recoverFull=()=>{document.getElementById("n").value=window.localStorage.getItem(`${cinimaName}n`),document.getElementById("m").value=window.localStorage.getItem(`${cinimaName}m`),document.getElementById("aisleRow").value=window.localStorage.getItem(`${cinimaName}row`),document.getElementById("aislecol").value=window.localStorage.getItem(`${cinimaName}col`);let e="",t=!1;for(var l=0;l<localStorage.length;l++){let n=localStorage.key(l);if(n.startsWith(cinimaName)){let i=n.split("_z_");if(!i[1])continue;e+=`<option>${i[1]}</option>`,!1==t&&(recover(n),t=!0)}}e+="<option>新建时刻</option>";let a=document.getElementById("timeSelect");a.innerHTML=e,timeName=a.options[a.selectedIndex].innerHTML};function generateGrid(e){if(e)for(var t=0;t<localStorage.length;t++){let l=localStorage.key(t);l.startsWith(cinimaName)&&window.localStorage.removeItem(l)}if(window.localStorage.getItem(`${cinimaName}n`)){recoverFull();return}var n=document.getElementById("my-svg"),i=parseInt(document.getElementById("n").value),a=parseInt(document.getElementById("m").value),r=document.getElementById("aislecol").value.split(" ").map(e=>parseInt(e)-1),m=document.getElementById("aisleRow").value.split(" ").map(e=>parseInt(e)-1);for(n.getBoundingClientRect().width,n.getBoundingClientRect().height;n.firstChild;)n.removeChild(n.firstChild);let o=0,s=0;for(var t=0;t<i;t++)for(var c=0;c<a;c++){var g={x:100+52*t,y:100+60*c};let d=0;for(;d<r.length&&t>r[d];)g.x+=30,d++;for(d=0;d<m.length&&c>m[d];)g.y+=30,d++;generateNode(n,g,{width:50,height:50},2,10,t,c),o=Math.max(o,g.x+50+100),s=Math.max(s,g.y+50+100)}for(let y=0;y<a;y++){let u={x:5,y:100+60*y+100/3},$=0;for(;$<m.length&&y>m[$];)u.y+=30,$++;generateRow(n,u,`第${a-y}排`)}n.style.width=o,n.style.height=s}document.addEventListener("keydown",function(e){var t=e.which||e.keyCode,l=e.ctrlKey?e.ctrlKey:17===t;if("Delete"===e.key||46===e.keyCode&&selectedSeat.length>0){for(let n of selectedSeat){let i=document.getElementsByName(n.getAttribute("name"));for(;i.length;)i[0].remove()}selectedSeat[0].remove(),selectedSeat=[]}if(86==t&&l){if(console.log("Ctrl+V is pressed."),!copyedSeat||0===selectedSeat.length)return;let a=document.getElementsByName(copyedSeat.getAttribute("name")),r=document.getElementsByName(selectedSeat.getAttribute("name"));r[0].style.color=a[0].style.color,r[0].setAttribute("fill",a[0].getAttribute("fill"));var m=r[1].getBBox(),o=m.width;r[1].innerHTML=a[1].innerHTML,m=r[1].getBBox().width;let s=parseFloat(r[1].getAttribute("x"));r[1].setAttribute("x",s+o/2-m/2),r[0].firstChild.innerHTML=a[0].firstChild.innerHTML}else if(67==t&&l){if(0===selectedSeat.length)return;copyedSeat=selectedSeat[0]}else l&&(multiSelect=!0)}),document.addEventListener("keyup",function(e){e.which||e.keyCode,e.ctrlKey&&e.ctrlKey,console.info(multiSelect),multiSelect=!1,console.info(multiSelect)}),generateGrid();

  </script>
</html>
